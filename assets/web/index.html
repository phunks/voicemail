<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>voicemail</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/hover.css" rel="stylesheet">
    <script src="js/g711.js"></script>
    <script src="js/utils.js"></script>
</head>
<body class="bg-light">

<div class="container py-5" style="width:800px">
    <h1 class="text-center mb-4">üìûvoicemail</h1>

    <div id="voicemail-list" class="list-group"></div>
</div>
<script>
    async function loadMessages() {
        if (navigator.language.startsWith('ja')) {
            msg = await import('./js/ja-jp.js');
        } else {
            msg = await import('./js/en-us.js');
        }
        return msg;
    }
    async function loadVoices() {
        const listElem = document.getElementById('voicemail-list');

        listElem.innerHTML = '<div class="text-center text-secondary">'+msg.LOADING+'</div>';

        try {
            const lists = await fetch('/api/all')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    return data;
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });

            if (lists.length === 0) {
                listElem.innerHTML = '<div class="text-center text-muted">'+msg.NO_CALL+'</div>';
                return;
            }

            listElem.innerHTML = '';
            let n = 0;
            lists.forEach(json => {
                n += 1
                const voiceItem = document.createElement('div');
                voiceItem.className = 'list-group-item d-flex justify-content-between align-items-center';

                const voiceNo = document.createElement('div');
                voiceNo.textContent = n;
                voiceNo.className = 'col-sm-1 text-left';
                const voiceId = document.createElement('div');
                voiceId.textContent = json.VoiceList.id;
                voiceId.className = 'voiceid';
                const voiceDate = document.createElement('div');
                voiceDate.textContent = local_time_fmt(json.VoiceList.event_time);
                voiceDate.className = 'col-sm-6 text-left';
                const voiceCaller = document.createElement('div');
                voiceCaller.textContent = json.VoiceList.caller;
                voiceCaller.className = 'editable col-sm-3 text-right';
                const voiceTel = document.createElement('div');
                voiceTel.textContent = json.VoiceList.tel;
                voiceTel.className = 'tel';

                const delBtn = document.createElement('img');
                delBtn.src = 'img/del.png';
                delBtn.alt = msg.DEL_VOICE;
                delBtn.onclick = () => deleteVoiceData(json.VoiceList.id);
                const playBtn = document.createElement('img');
                playBtn.src = 'img/play.png';
                playBtn.alt = msg.PLAY_VOICE;
                playBtn.onclick = () => playVoiceData(json.VoiceList.id);

                voiceItem.appendChild(voiceNo);
                voiceItem.appendChild(voiceId);
                voiceItem.appendChild(voiceDate);
                voiceItem.appendChild(voiceCaller);
                voiceItem.appendChild(voiceTel);
                voiceItem.appendChild(delBtn);
                voiceItem.appendChild(playBtn);
                listElem.appendChild(voiceItem);
            });

            document.addEventListener('click', function(e) {
                const target = e.target;

                if (target.classList.contains('editable')) {
                    const originalText = target.textContent;
                    const tel = target.parentElement.getElementsByClassName('tel')[0].textContent;

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = originalText;
                    input.className = 'form-control form-control-sm';
                    input.style.textAlign = 'right';

                    target.textContent = '';
                    target.appendChild(input);
                    input.focus();

                    const commitEdit = () => {
                        const newValue = input.value.trim();

                        if (newValue !== originalText) {
                            fetch(`/api/mod`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ tel: tel, name: newValue })
                            })
                                .then(response => {
                                    if (!response.ok) throw new Error(msg.SRV_ERROR);
                                })
                                .then(data => {
                                    location.reload();
                                })
                                .catch(err => {
                                    alert(msg.UPD_FAILED + err.message);
                                    target.textContent = originalText;
                                });
                        } else {
                            target.textContent = originalText;
                        }
                    };

                    input.addEventListener('blur', commitEdit);
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            commitEdit();
                        } else if (e.key === 'Escape') {
                            target.textContent = originalText;
                        }
                    });
                }
            });
        } catch (err) {
            console.error(msg.READ_ERROR, err);
            listElem.innerHTML = '<div class="text-danger text-center">'+msg.LOAD_ERROR+'</div>';
        }
    }

    async function deleteVoiceData(id) {
        if (!confirm(msg.DEL_REC)) return;

        try {
            const res = await fetch(`/api/del/${id}`, {
                method: 'GET'
            });

            if (res.ok) {
                await loadVoices(); // ÂÜçË™≠„ÅøËæº„Åø
            } else {
                alert(msg.DEL_FAILED);
            }

        } catch (err) {
            console.error(msg.DEL_ERROR, err);
            alert(msg.DEL_ERROR);
        }
    }

    function local_time(event_time) {
        return new Date(Date.parse(event_time)).toLocaleString(navigator.language, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            weekday: 'short',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
    }

    function local_time_fmt(event_time) {
        return new Intl.DateTimeFormat(navigator.language, {
            dateStyle: "long",
            timeStyle: "medium",
            hour12: false,
        }).format(new Date(Date.parse(event_time)));
    }

    var msg = loadMessages();
    // ÂàùÊúüË™≠„ÅøËæº„Åø
    loadVoices();
</script>

</body>
</html>